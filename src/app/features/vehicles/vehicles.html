<div class="grid">
    <div class="col-12">
        <!-- Page Header -->
        <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center mb-4">
            <div>
                <h1 class="text-3xl font-bold text-900 mb-2">Araçlar</h1>
                <span class="text-500 font-medium">Filo araçlarınızı buradan yönetebilirsiniz.</span>
            </div>
            <div class="mt-3 md:mt-0">
                <button pButton pRipple label="Yeni Araç Ekle" icon="pi pi-plus"
                    class="p-button-primary border-round-lg shadow-2" (click)="openNew()"></button>
            </div>
        </div>

        <!-- Table Card -->
        <div class="card p-0 border-none shadow-2 border-round-xl overflow-hidden">
            <p-table #dt [value]="vehicles" [rows]="10" [paginator]="true" [rowsPerPageOptions]="[10,20,30]"
                [globalFilterFields]="['plate_number','driver_name','driver_phone']" responsiveLayout="scroll"
                [rowHover]="true" dataKey="id" [loading]="loading" styleClass="p-datatable-sm"
                currentPageReportTemplate="Toplam {totalRecords} kayıttan {first} ile {last} arası gösteriliyor"
                [showCurrentPageReport]="true">

                <ng-template pTemplate="caption">
                    <div
                        class="flex justify-content-between align-items-center p-3 surface-0 border-bottom-1 surface-border">
                        <span class="p-input-icon-left w-full md:w-auto">
                            <i class="pi pi-search text-500"></i>
                            <input pInputText type="text"
                                (input)="dt.filterGlobal($any($event.target).value, 'contains')"
                                placeholder="Araç Ara..." class="w-full md:w-20rem border-round-lg pl-5" />
                        </span>
                        <button pButton pRipple icon="pi pi-refresh"
                            class="p-button-text p-button-secondary p-button-rounded" (click)="loadVehicles()"
                            pTooltip="Listeyi Yenile"></button>
                    </div>
                </ng-template>

                <ng-template pTemplate="header">
                    <tr class="bg-gray-50 text-600 uppercase text-sm font-semibold">
                        <th style="width: 3rem">#</th>
                        <th pSortableColumn="plate_number" class="white-space-nowrap">Plaka <p-sortIcon
                                field="plate_number"></p-sortIcon></th>
                        <th pSortableColumn="driver_name">Sürücü Adı <p-sortIcon field="driver_name"></p-sortIcon></th>
                        <th pSortableColumn="driver_phone">Telefon <p-sortIcon field="driver_phone"></p-sortIcon></th>
                        <th *ngIf="isAdmin" pSortableColumn="profiles.email">Kullanıcı <p-sortIcon field="profiles.email"></p-sortIcon></th>
                        <th class="text-right">İşlemler</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-vehicle let-i="rowIndex">
                    <tr class="transition-colors transition-duration-200 hover:surface-hover">
                        <td class="text-500 font-medium">{{i + 1}}</td>
                        <td>
                            <div class="font-medium text-900">{{vehicle.plate_number}}</div>
                        </td>
                        <td class="text-600">
                            {{vehicle.driver_name || '-'}}
                        </td>
                        <td class="text-600">
                            {{vehicle.driver_phone || '-'}}
                        </td>
                        <td *ngIf="isAdmin" class="text-600">
                            <div class="flex align-items-center gap-2">
                                <span class="w-2rem h-2rem border-circle bg-primary-100 flex align-items-center justify-content-center text-primary-600 font-bold text-sm">
                                    {{(vehicle.profiles?.full_name || vehicle.profiles?.email || 'U')[0].toUpperCase()}}
                                </span>
                                <div class="flex flex-column">
                                    <span class="text-sm font-medium">{{vehicle.profiles?.full_name || '-'}}</span>
                                    <span class="text-xs text-500">{{vehicle.profiles?.email || '-'}}</span>
                                </div>
                            </div>
                        </td>
                        <td class="text-right">
                            <div class="flex justify-content-end gap-2">
                                <button pButton pRipple icon="pi pi-pencil"
                                    class="p-button-rounded p-button-text p-button-info" (click)="editVehicle(vehicle)"
                                    pTooltip="Düzenle"></button>
                                <button pButton pRipple icon="pi pi-trash"
                                    class="p-button-rounded p-button-text p-button-danger"
                                    (click)="deleteVehicle(vehicle)" pTooltip="Sil"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td [attr.colspan]="isAdmin ? 6 : 5" class="text-center p-5">
                            <i class="pi pi-car text-5xl text-400 mb-3"></i>
                            <div class="text-700 font-medium">Henüz kayıtlı araç yok.</div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>

        <!-- Edit Dialog -->
        <p-dialog [(visible)]="vehicleDialog" [style]="{width: '500px'}" header="Araç Bilgileri" [modal]="true"
            class="p-fluid" [draggable]="false" [resizable]="false">
            <ng-template pTemplate="content">
                <form [formGroup]="vehicleForm" class="flex flex-column gap-4 pt-3">

                    <!-- Plate Number -->
                    <div class="field mb-0">
                        <label for="plate_number" class="block text-900 font-semibold mb-2">Plaka</label>
                        <input type="text" pInputText id="plate_number" formControlName="plate_number" required
                            autofocus placeholder="Örn: 34 ABC 123" class="w-full" />
                        <small class="p-error block mt-2" *ngIf="submitted && vehicleForm.get('plate_number')?.invalid">
                            Plaka zorunludur.
                        </small>
                    </div>

                    <!-- Driver Name -->
                    <div class="field mb-0">
                        <label for="driver_name" class="block text-900 font-semibold mb-2">Sürücü Adı</label>
                        <input type="text" pInputText id="driver_name" formControlName="driver_name"
                            placeholder="Sürücü adı soyadı" class="w-full" />
                    </div>

                    <!-- Driver Phone -->
                    <div class="field mb-0">
                        <label for="driver_phone" class="block text-900 font-semibold mb-2">Sürücü Telefon</label>
                        <p-inputMask mask="(999) 999-9999" formControlName="driver_phone" placeholder="(5XX) XXX-XXXX"
                            styleClass="w-full"></p-inputMask>
                    </div>
                </form>
            </ng-template>

            <ng-template pTemplate="footer">
                <div class="flex justify-content-end gap-2 border-top-1 surface-border pt-3">
                    <button pButton pRipple label="İptal" icon="pi pi-times"
                        class="p-button-text p-button-secondary border-round-lg" (click)="hideDialog()"></button>
                    <button pButton pRipple label="Kaydet" icon="pi pi-check"
                        class="p-button-primary border-round-lg px-4" (click)="saveVehicle()"></button>
                </div>
            </ng-template>
        </p-dialog>

        <!-- Bağlı Kayıtlar Dialog -->
        <p-dialog [(visible)]="dependencyDialog" [style]="{width: '600px'}" 
            [header]="(vehicleDependencies.contracts.length > 0 || vehicleDependencies.logs.length > 0) ? 'Bağlı Kayıtlar' : 'Aracı Silmek İster misiniz?'" 
            [modal]="true"
            class="p-fluid" [draggable]="false" [resizable]="false">
            <ng-template pTemplate="content">
                <div class="flex flex-column gap-4 pt-3">
                    <!-- Bağlı kayıt varsa göster -->
                    <div *ngIf="vehicleDependencies.contracts.length > 0 || vehicleDependencies.logs.length > 0">
                        <div class="flex align-items-center gap-2 text-orange-500">
                            <i class="pi pi-exclamation-triangle text-xl"></i>
                            <span class="font-semibold text-lg">
                                {{vehicleToDelete?.plate_number}} plakalı araca bağlı kayıtlar bulunmaktadır.
                            </span>
                        </div>
                        <p class="text-600 m-0">Bu aracı silmek için önce aşağıdaki kayıtları silmeniz gerekmektedir:</p>
                    </div>

                    <!-- Bağlı Sözleşmeler -->
                    <div *ngIf="vehicleDependencies.contracts.length > 0" class="border-round-lg border-1 surface-border p-3">
                        <div class="flex align-items-center gap-2 mb-3">
                            <i class="pi pi-file text-primary"></i>
                            <span class="font-semibold">Sözleşmeler ({{vehicleDependencies.contracts.length}})</span>
                        </div>
                        <div class="flex flex-column gap-2">
                            <div *ngFor="let contract of vehicleDependencies.contracts" class="flex align-items-center justify-content-between p-2 surface-100 border-round gap-2">
                                <div class="flex flex-column flex-1">
                                    <span class="font-medium">{{contract.companies?.name || 'Bilinmeyen Şirket'}}</span>
                                    <span class="text-sm text-500">
                                        {{contract.start_date | date:'dd.MM.yyyy'}} - 
                                        {{contract.end_date ? (contract.end_date | date:'dd.MM.yyyy') : 'Devam Ediyor'}}
                                    </span>
                                </div>
                                <div class="flex align-items-center gap-2">
                                    <span *ngIf="contract.vehicle_id === null" class="text-xs text-orange-500 font-medium">
                                        (Tüm Araçlar)
                                    </span>
                                    <button pButton pRipple icon="pi pi-trash" 
                                        class="p-button-rounded p-button-text p-button-danger p-button-sm"
                                        (click)="deleteContractFromDialog(contract)"
                                        pTooltip="Sözleşmeyi Sil"
                                        tooltipPosition="top"></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bağlı Günlük Kayıtlar -->
                    <div *ngIf="vehicleDependencies.logs.length > 0" class="border-round-lg border-1 surface-border p-3">
                        <div class="flex align-items-center gap-2 mb-3">
                            <i class="pi pi-calendar text-primary"></i>
                            <span class="font-semibold">Günlük Kayıtlar ({{vehicleDependencies.logs.length}})</span>
                        </div>
                        <div class="flex flex-column gap-2">
                            <div *ngFor="let log of vehicleDependencies.logs" class="flex align-items-center justify-content-between p-2 surface-100 border-round gap-2">
                                <div class="flex flex-column flex-1">
                                    <span class="font-medium">{{log.companies?.name || 'Bilinmeyen Şirket'}}</span>
                                    <span class="text-sm text-500">{{log.date | date:'dd.MM.yyyy'}}</span>
                                </div>
                                <div class="flex align-items-center gap-2">
                                    <span class="font-semibold text-primary">{{log.calculated_fee | currency:'TRY':'symbol-narrow'}}</span>
                                    <button pButton pRipple icon="pi pi-trash" 
                                        class="p-button-rounded p-button-text p-button-danger p-button-sm"
                                        (click)="deleteLogFromDialog(log)"
                                        pTooltip="Günlük Kaydı Sil"
                                        tooltipPosition="top"></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tüm bağlı kayıtlar silindiğinde gösterilecek onay mesajı -->
                    <div *ngIf="vehicleDependencies.contracts.length === 0 && vehicleDependencies.logs.length === 0" 
                        class="border-round-lg border-1 surface-border p-4 bg-green-50">
                        <div class="flex align-items-center gap-3 mb-3">
                            <i class="pi pi-check-circle text-green-500 text-2xl"></i>
                            <span class="font-semibold text-lg text-900">Tüm bağlı kayıtlar silindi.</span>
                        </div>
                        <p class="text-600 mb-4">Bu aracı silmek istediğinize emin misiniz?</p>
                        <div class="flex justify-content-end gap-2">
                            <button pButton pRipple label="Hayır" icon="pi pi-times"
                                class="p-button-text p-button-secondary border-round-lg"
                                (click)="closeDependencyDialog()"></button>
                            <button pButton pRipple label="Evet, Sil" icon="pi pi-trash"
                                class="p-button-danger border-round-lg"
                                (click)="deleteVehicleFromDialog()"></button>
                        </div>
                    </div>
                </div>
            </ng-template>

            <ng-template pTemplate="footer">
                <div class="flex justify-content-end gap-2" *ngIf="vehicleDependencies.contracts.length > 0 || vehicleDependencies.logs.length > 0">
                    <button pButton pRipple label="Kapat" icon="pi pi-times"
                        class="p-button-text p-button-secondary border-round-lg"
                        (click)="closeDependencyDialog()"></button>
                </div>
            </ng-template>
        </p-dialog>
    </div>
</div>